# 딥러닝 기반 얼굴 모자이크 처리 (SWCON321-01)

* 소프트웨어융합학과 정환석

## 1. 과제 개요

### 가. 과제 선정 배경 및 필요성

최근 유튜브, 틱톡, 인스타그램 등을 통해 개인이 촬영한 사진이나 동영상이 인터넷에 공개되고 있는 만큼 초상권 침해 문제가 심각해지고 있다. 영상물에 나오는 사람들의 촬영 동의를 받지 않는다면 이는 초상권 침해에 해당하고, 심지어 영상 촬영에 동의를 받았다고 하더라도 초상권 침해에 성립하는 경우도 있다. 하 지만 모자이크 처리를 하는 경우에는 초상권 침해가 되지 않는다 따라서 영상물에 나오는 사람들의 얼굴을 모자이크 처리하는 기술이 필요하다.

### 나. 과제 주요내용

1) MTCNN 을 활용하여 얼굴을 검출한다.
2) Face-Net 을 활용하여 얼굴을 식별한다.
3) SORT 를 활용하여 얼굴을 트래킹한다.
4) 특정 인물을 제외한 사람들의 얼굴을 모자이크 처리한다.


## 2. 과제의 목표

사진이나 영상에 나오는 사람들의 얼굴을 인식하고 특정 인물(출연자)을 제외한 나머지 얼굴들을 모자이크 처리한다.


## 3. 기대효과 및 활용방안

딥러닝 기반 얼굴 모자이크 처리 기술을 통해서 영상 출연자 이외 사람들은 초상권이나 사생활 침해를 당 할 걱정을 줄일 수 있고, 게시자는 영상물을 업로드할 때 보다 편리하고 자유롭게 할 수 있다.


## 4. 수행방법

### 가. MTCNN (Object Detection)
- MTCNN 은 얼굴 검출에 많이 사용되는 모델로 높은 성능과 빠른 속도를 보여준다.
- MTCNN 은 P-Net, R-Net, O-Net 이라는 CNN 을 순서대로 통과하는 Cascade 모델이다.

0) 이미지를 각기 다른 크기로 resize 하여 Image Pyramid 를 만든다.
1) P-Net 은 이미지에서 얼굴을 찾아내는 네트워크이다.
2) R-Net 은 이전 단계에서 찾아낸 후보 영역을 추려내는 네트워크이다.
3) O-Net 은 이전 단계에서 찾아낸 후보 영역에서 face landmark(눈, 코, 입 좌표)를 찾아내는 네트워크이
다.

### 나. Face-Net (얼굴 식별)
Face-Net 은 얼굴 식별을 위한 모델로 얼굴 이미지에서 그 사람에 대한 특징 값을 128 차원으로 임베딩해 결과를 구해주는 모델이다. 이 값을 활용하여 유클리드 공간에서 이미지간 거리를 통해 얼굴 이미지를 분 류 할 수 있다.
Face-Net 에서는 Triplet Loss 라는 개념이 사용된다. Triplet Loss 는 어떤 사람(Anchor)과 같 사람(Positive), 다른 사람(Negative)이 등장하는데 학습 미니 배치 안에서 Anchor, Positive, Negative 들이 임베딩된 값들 의 유클리드 거리를 구해 Loss 함수를 만든다. Loss 를 최소화하기 위해서 Anchor 와 Positive 의 거리는 가 까워지도록 하고 Negative 와 거리는 멀어지도록 한다. 그리고 Hard Positive(같은 사람이지만 다르게 보이는 사람)는 학습을 진행하지만 Hard Negative(다른 사람이지만 닮은 사람)는 조건이 만족하는 경우에만 학 습을 진행한다.

### 다. Face Alignment
Face-Net 은 alignment 과정이 없어도 성능이 우수하지만, alignment 과정을 추가해주면 조금이라도 성능 이 좋아지기때문에 이 과정을 추가해주었다.
Face Alignment 는 MTCNN 으로 얼굴을 검출하고 face landmark 중 양쪽 눈 좌표를 이용하여 코사인법칙 을 활용해 기울어진 각도만큼 회전하는 방식으로 정렬해주었다.

### 라. SORT (Object Tracking)
실시간으로 객체를 연관시키는데 중점을 두는 다중 객체 추정 방식으로 Kalman Filter 와 Hungarian Algorithm 과 같은 기초적인 구성만으로 높은 정확도를 보이고 추적 방식의 단순함 때문에 빠른 속도로 업 데이트할 수 있다.
Kalman Filter 는 과거의 정보와 새로운 측정값을 사용하여 측정값에 포함된 노이즈를 제거시켜 추정하는 최우선 추정 알고리즘이다. SORT 에서 칼만필터를 사용한 이유는 이동방향이 선형적으로 있는데 Detector 의 결과가 위쪽으로 치우쳐지게 나오면 박스가 떨리게 되면서 불안정해 보이게 되는데 이를 해결하기 위해 이전 데이터를 사용하여 새로운 위치를 예측하는 칼만필터가 적용되어 부드럽게 추적할 수 있다. Hungarian Algorithm 은 비용을 최소화 시키는 할당 알고리즘으로 칼만필터에서 나온 결과와 현재 Detector 에서 나 온 바운딩 박스를 매칭시켜 ID 를 할당해준다. 이렇게 이전 프레임에서 검출된 얼굴과 현재 프레임에서 검 출된 얼굴을 매칭시켜 한번 검증된 얼굴에 대해서는 얼굴 검증 단계를 거치지 않도록 하여 빠른 처리를 할 수 있도록 한다.
  
### 마. 모자이크 처리
얼굴 식별을 통해 등록된 인물 목록에 없는 사람의 얼굴은 이미지에서 모자이크 처리를 한다.


## Results

* 사진이나 영상에서 얼굴을 검출하고, 그 얼굴이 누구인지 분류한다. 그리고 출연자 리스트에 없는 얼굴은 모자이크 처리한다.

- MTCNN 을 활용하여 얼굴 검출 성능은 뛰어나지만 처리 속도가 느리다.
- 적은 수의 얼굴 데이터만으로 사람의 얼굴은 분류할 수 있다.
- 영상에 처리 속도를 향상시키기 위해서 추적 중이던 얼굴에 대해서는 얼굴 분류 과정을 생략한다.


## Conclusion

* MTCNN 을 활용하여 얼굴 검출 성능을 향상시켰지만 처리 속도가 느리기 때문에 영상을 모자이크 처리하 는데 시간이 오래 걸린다. 하지만 애플리케이션 레벨에서 생각했을 때, 출연자가 아닌 사람의 얼굴이 노출 되는 것이 문제가 되므로 처리속도 보다 얼굴 검출 성능을 향상시키는게 옳다고 판단하였다.


## Reports

* Final: [Report](reports/final_report.pdf)
